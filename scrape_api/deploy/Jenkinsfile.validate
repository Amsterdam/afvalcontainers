#!groovy

def tryStep(String message, Closure block, Closure tearDown = null) {
    try {
        block()
    }
    catch (Throwable t) {
        slackSend message: "${env.JOB_NAME}: ${message} failure ${env.BUILD_URL}", channel: '#ci-channel', color: 'danger'

        throw t
    }
    finally {
        if (tearDown) {
            tearDown()
        }
    }
}


node {
    stage("Checkout") {
        checkout scm
    }

    stage("Check database") {
        OUTPUT = sh(
            script: 'import/check.sh',
            returnStdout: true
        ).trim()
        slacksend(
            channel: '#niels-test', 
            color: 'warning', 
            message: "Something is wrong\nFoo\nBar\n${OUPUT}"
        )
    }
}
